{
  "name": "nox",
  "version": "0.1.0",
  "description": "Nox - write Node.js web apps faster",
  "main": "lib/nox-server.js",
  "repository": {
    "type": "git",
    "url": "https://github.com/asaarinen/nox.js.git"
  },
  "author": {
    "name": "Antti Saarinen",
    "email": "antti.p.saarinen@gmail.com"
  },
  "keywords": [
    "browser",
    "require",
    "commonjs",
    "commonjs-esque",
    "rpc",
    "server",
    "javascript",
    "api",
    "bundle",
    "callbacks"
  ],
  "license": "MIT",
  "readmeFilename": "README.md",
  "dependencies": {
    "async": "~0.2.9",
    "socket.io": "~0.9.16",
    "uglify-js": "~2.3.6"
  },
  "devDependencies": {
    "express": "~3.3.4",
    "nedb": "~0.8.5"
  },
  "readme": "Nox.js - write Node.js web apps faster\n===\n\n* <a href=\"#how-does-it-work\">How Does It Work?</a>\n* <a href=\"#getting-started\">Getting Started</a>\n* <a href=\"#examples\">Examples</a>\n* <a href=\"#api-reference\">API Reference</a>\n* <a href=\"#license\">License (MIT)</a>\n\nNox enables you to fluently mix browser-side JavaScript and server-side Node.js code like this:\n\n```javascript\nvar fs = require('fs');\nvar async = require('async');\n\n$(document).ready(function() {\n    async.waterfall([\n        function(wfcb) {\n            fs.readdir('.', wfcb);\n        },\n        function(files, wfcb) {\n            async.eachSeries(files, function(filename, filecb) {\n                fs.stat(filename, function(err, stats) {\n                    if( err ) \n                        stats = { size: 'n/a' }\n                    var li = document.createElement('li');\n                    $(li).text(filename + ' ' + stats.size);\n                    $('ul').append(li);\n                    filecb();\n                });\n            }, wfcb);\n        }\n    ], function(err) {\n        if( err )\n            alert('Error listing files: ' + err);\n    });\n});\n```\n\nNox is an __experiment to boost developer producitivy__ by\n\n* having __minimal learning curve__, just get coding without having to spend time studying Nox itself.\n* maximizing __code reuse__ by using the exact same codebase in client and server\n* allowing a __JavaScript API__ to be used in the browser, instead of building a REST API and making Ajax calls\n* keeping the codebase __unit testable__ in the back end, including the browser parts (a work in progress)\n\nNox is still in an experimental phase, but it is fun to play around with; it doesn't get in your way at all, and lets you focus on writing the actual application logic instead of learning platform quirks. (Unlike some web MVC frameworks not mentioned here.) \n\n## How Does It Work?\n\nNox works by wrapping and compiling all JavaScript modules into a single JavaScript bundle (usually named nox-client.js), that is included inside each HTML page using Nox.\n\n* For JavaScript that is executed locally in the browser, this wrapping pretty much only includes a closure with the CommonJS require() and module.exports, optionally uglifying the result.\n\n* For JavaScript code executed on the server, all functions exported by the module are wrapped inside a function which, when called in the browser, serialize the arguments and send them over a websocket connection to the server. \n\nThis means that \n\n* only JSON stringifiable arguments can be used, with the notable addition of functions; for function arguments, a unique callback id is generated and passed to server, enabling the server to call the callback when appropriate.\n\n* all remote functions called must be asynchronous (e.g. deliver the result via a callback), which fortunately is the standard way of working with Node.js.\n\n* if the websocket connection is lost, your callbacks never get called. To mitigate this problem, you can \n  - add a listener to detect socket connectivity events \n  - use modules like <a href=\"https://github.com/creationix/safereturn\">safereturn</a> to give your callback a timeout\n\n### Security & Authentication\n\nThe JavaScript modules available to each web page are defined on the server side. While also native Node.js modules can be exposed, typically it is an application-specific module that exports the kind of API that the web app would need. \n\nThis means that Nox does not allow an adversary to just make `fs` calls on your server filesystem (like the example at the top of this page) unless the server permits that. (Exposing built-in modules should not be done except when building desktop apps with a browser UI, which is BTW an interesting use case).\n\nWhen using Nox, you can do user authentication exactly as you have been doing it before; when a connection is established, Nox checks that there is a HTTP session matching the cookie or declines the connection if one is not found. \n\nFor each remote call coming to the server, Nox fetches the HTTP session associated to that connection and adds it to the currently active domain, where it can be accessed like this:\n\n```\nfunction getUserName(callback) {\n  var username = domain.active.httpSession.username;\n  if( username )\n    callback(null, { name: username });\n  else\n    callback('Not Authorized');\n}\n```\n\nIf you need to access the session information in some other modules, you will need to either pass session information around in function arguments, or make sure that the domain is bound to all subsequent events and callbacks when executing the remote function call.\n\nNox relies on browser websocket implementations to secure the contents of the function calls. Each generated nox-client.js bundle includes a unique identifier that is used, together with the cookie, to identify the caller. \n\n### Unit Testing\n\nJavaScript modules used by Nox can be run in Node.js as such via command line. This enables easy unit testability of back- and front-end code together.\n\nA more complete out-of-the-box capability of running tests would include either running them in the browser (or PhantomJS) or instantiating a JSDOM environment in which the code is executed. This has not yet been implemented but has been thought about. Contributors welcome.\n\n## Getting Started\n\nThis guide details to you how to get up and running with Nox.\n\n### Server side       \n\nOn server side, you need to install nox via\n\n```\nnpm install nox\n```\n\nThen, create a nox app like this:\n\n```javascript\nvar noxapp = require('nox').nox(\n    function(str) { return require(str); },\n    'nox-test.sid');\n```\n\nThe first argument to is a function that requires a module - it is needed for the nox library to be able to require modules relative to current path (vs. the path where nox is installed). The second argument is a sid that is used to match HTTP session cookies to websocket connections, so it should match what you passed to `express.session()`.\n\nAfter that, you can attach the `/nox-client.js` (or you name it) to your HTTP server, like this:\n\n```javascript\nexpressServer.get('/nox-client.js', noxapp.get);\n```\n\nand attach the websocket connections like this:\n\n```javascript\nvar socketServer = require('socket.io').listen(httpServer);\nsocketServer.set('authorization', noxapp.socketAuth);\nsocketServer.on('connection', noxapp.socketConn);\n```\n\nAfter that, you need to specify which pages are allowed to use Nox, and which remote and local modules are allowed for each page, like this:\n\n```javascript\nnoxapp.page('/async/client.html', // when serving page /async/client.html\n            [ 'fs' ],             // bundle remote interface for fs calls\n            [ './async/client.js' ]);  // and bundle async/client.js locally\n```\n\nNox actually uses the HTTP Referrer header to deduce which page Nox is being requested for.\n\nA complete example server using Nox can be found in the examples directory.\n\n### Client side\n\nOn client side, you need to just include relevant JavaScript files to each HTML page, for example:\n\n```html\n    <script src=\"/socket.io/socket.io.js\"></script>\n    <script src=\"/nox-client.js\"></script>\n```\n\nAnd that's it! Typically there is a JavaScript module for each page that actually starts calling `$(document).ready` and so on to initialize the page, which is included in the `nox-client.js` bundle.\n\n## Examples\n\nThese examples can be run in the `example/` directory by saying `node nox-example-server.js` and going to `localhost:8080/nssh/client.html` or similar for each example. Make sure you are in that directory when starting `node` in order for the module file paths to match.\n\n### Non-Secure Shell\n\nProbably the most insecure shell ever written, this example opens a local shell on your server and lets you do anything:\n\n![Screenshot](https://github.com/asaarinen/nox.js/raw/master/doc/nssh.png)\n\nServer-side code:\n\n```javascript\nvar childp = require('child_process');\n\nexports.open = function(outcb, callback) {\n    var proc = childp.spawn('sh', []);\n    proc.stdout.on('readable', function() {\n        var buf = proc.stdout.read();\n        if( buf )\n            outcb(buf.toString('utf8'));\n    });\n    proc.stderr.on('readable', function() {\n        var buf = proc.stderr.read();\n        if( buf )\n            outcb(buf.toString('utf8'));\n    });\n    callback(function(str) {\n        proc.stdin.write(str + '\\n');\n    });\n}\n\n```\n\nClient-side code:\n\n```javascript\nvar nssh = require('./nssh.js');\n\n$(document).ready(function() {\n    nssh.open(\n        function(outstr) {\n            var rows = outstr.split('\\n');\n            for( var ri = 0; ri < rows.length; ri++ ) {\n                var li = document.createElement('li');\n                $(li).text(rows[ri]).css('color', '#0f0f0f');\n                $('ul').append(li);\n            }\n        },\n        function(infun) {\n            $('input').keypress(function(event) {\n                if( event.keyCode == 13 ) {\n                    var cmd = $('input').val();\n                    $('input').val('');\n                    var li = document.createElement('li');\n                    $(li).text('$ ' + cmd).css('color', '#54f75d');\n                    $('ul').append(li);\n                    infun(cmd);\n                }\n            });\n        });\n});\n```\n\n### Basic CRUD app\n\nThis basic CRUD app just shows how to add components to a NeDB database:\n\n![Screenshot](https://github.com/asaarinen/nox.js/raw/master/doc/crud.png)\n\nServer-side code:\n\n```javascript\nvar Datastore = require('nedb');\nvar db = new Datastore();\n\nexports.create = function(name, callback) {\n    db.insert({name: name}, callback);\n}\n\nexports.update = function(id, newname, callback) {\n    db.update({ _id: id }, { $set: { name: newname } }, callback);\n}\n\nexports.remove = function(id, callback) {\n    db.remove({ _id: id }, {}, callback);\n}\n\nexports.list = function(callback) {\n    db.find({}, callback);\n}\n```\n\nClient-side code:\n\n```javascript\nvar crud = require('./crud.js');\n\nfunction updatelist(err) {\n    crud.list(function(err, people) {\n        $('ul').empty();\n        for( var pi = 0; pi < people.length; pi++ ) {\n            var fun = function(id, name) {\n                var li = document.createElement('li');\n                $(li).append('<span>' + name + ' (' + id + ')</span>' + \n                             '<button class=\"update\">Update</button>' +\n                             '<button class=\"remove\">Remove</button>');\n                $(li).children('button.update').click(function() {\n                    var newname = prompt('New name', name);\n                    if( newname )\n                        crud.update(id, newname, updatelist);\n                });\n                $(li).children('button.remove').click(function() {\n                    crud.remove(id, updatelist);\n                });\n                $('ul').append(li);\n            };\n            fun(people[pi]._id, people[pi].name);\n        }\n    });\n}\n\n$(document).ready(function() {\n    updatelist();\n    $('input').keypress(function(event) {\n        if( event.keyCode == 13 ) {\n            var name = $('input').val();\n            $('input').val('');\n            crud.create(name, updatelist);\n        }\n    });\n});\n```\n\n### Image Thumbnail Generator\n\nThis code fetches image URLs and generates thumbnails, which are displayed on the webpage:\n\n![Screenshot](https://github.com/asaarinen/nox.js/raw/master/doc/img.png)\n\nServer-side code:\n\n```javascript\nvar async = require('async');\nvar http = require('http');\nvar fs = require('fs');\nvar childp = require('child_process');\n\nexports.getThumbnail = function(imgurl, thumbsize, callback) {\n    var ext = imgurl.match(/(\\.[^\\.]+)\\?.+$/);\n    if( ext )\n        ext = ext[1];\n    if( !ext )\n        ext = '';\n\n    var basename = 'tmpimg' + (Math.random() + '').substring(2);\n\n    async.waterfall([\n        function(wfcb) {\n            http.get(imgurl, function(res) { \n                res.pipe(fs.createWriteStream(basename + ext));\n                res.on('end', function() { wfcb(); });\n            }).on('error', function(err) {\n                wfcb(err);\n            });\n        },\n        function(wfcb) {\n            var proc = childp.spawn('gm', \n                                    [ 'convert', basename + ext,\n                                      '-resize', thumbsize + 'x' + thumbsize, \n                                      basename + thumbsize + ext ]);\n            proc.on('close', function(exitcode) {\n                if( exitcode )\n                    wfcb('error converting image');\n                else\n                    wfcb();\n            });\n        }\n    ], function(err) {\n        callback(err, '/' + basename + thumbsize + ext);\n    });\n}\n```\n\nClient-side code:\n\n```\nvar img = require('./img.js');\n\n$(document).ready(function() {\n    $('input').keypress(function(event) {\n        if( event.keyCode == 13 ) {\n            var name = $('input').val();\n            $('input').val('');\n            img.getThumbnail(name, 128, function(err, imgurl) {\n                if( err )\n                    alert(err);\n                else\n                    $('div').append('<img style=\"float: left;\" src=\"' + imgurl + '\" />');\n            });\n        }\n    });\n});\n```\n\n### Session Login \n\nThis example demonstrates a simple login form that can be used to authenticate users. \n\n![Screenshot](https://github.com/asaarinen/nox.js/raw/master/doc/session.png)\n\nServer-side code:\n\n```javascript\nvar domain = require('domain');\n\nexports.login = function(name, password, callback) {\n    if( domain.active.httpSession.username )\n        callback('already logged in');\n    else {\n        if( name + 'pass' == password ) {\n            // domain.active.httpSession is just a copy, so we have to\n            // modify the original in the session store\n            domain.active.httpSessionStore.modify(function(sess, cb) {\n                sess.username = name;\n                cb();\n            }, callback);\n        } else\n            callback('invalid password');\n    }\n}\n\nexports.logout = function(callback) {\n    domain.active.httpSessionStore.modify(function(sess, cb) {\n        delete sess.username;\n        cb();\n    }, callback);\n}\n\nexports.getUserName = function(callback) {\n    callback(null, domain.active.httpSession.username);\n}\n```\n\nClient-side code:\n\n```javascript\nvar session = require('./session.js');\n\nfunction updateStatus(err) {\n    if( err )\n        alert('Error: ' + err);\n    session.getUserName(function(err, name) {\n        if( name ) {\n            $('#status').text('Logged in as ' + name);\n            $('#controls').empty();\n            $('#controls').append('<button>Log out</button>');\n            $('#controls button').click(function() {\n                session.logout(updateStatus);\n            });\n        } else {\n            $('#status').text('Logged out');            \n            $('#controls').empty();\n            $('#controls').append(\n                '<p>Log in as:<input id=\"username\" placeholder=\"Name\"></p>' + \n                '<p>Password:<input id=\"password\" placeholder=\"Password\"></p>' + \n                '<button>Log in</button>');\n            $('#controls button').click(function() {\n                session.login($('#username').val(),\n                              $('#password').val(), updateStatus);\n            });\n        }\n    });\n}\n\n$(document).ready(function() { updateStatus(); });\n```\n\n### Chat server\n\nChat server example is a trivial chat server that broadcasts all messages to every other participant.\n\n![Screenshot](https://github.com/asaarinen/nox.js/raw/master/doc/chat.png)\n\nServer-side code:\n\n```javascript\nvar domain = require('domain');\n\nvar users = {};\nvar activeusers = {};\n\nexports.send = function(message) {\n    if( !domain.active.socketSession.username )\n        return;\n    for( var ai in activeusers )\n        activeusers[ai](domain.active.socketSession.username, message);\n}\n\nexports.login = function(name, password, recvfun, callback) {\n    if( users[name] == null )\n        users[name] = password;\n\n    if( users[name] == password && password ) {\n        domain.active.socketSession.username = name;\n        var sessionid = (Math.random() + '').substring(2);\n        activeusers[sessionid] = recvfun;\n        domain.active.socket.on('disconnect', function() {\n            delete activeusers[sessionid];\n        });\n        callback();\n    }  else\n        callback('error logging in');\n}\n```\n\nClient-side code:\n\n```javascript\nvar chat = require('./chat.js');\nvar async = require('async');\n\nvar username = null;\n\nfunction receiveChat(username, message) {\n    $('table').append('<tr><td>' + username + ':</td><td>' + message + '</td>');\n}\n\nfunction sendChat() {\n    var msg = $('input').val();\n    $('input').val('');\n    chat.send(msg);\n}\n\n$(document).ready(function() {\n    $('input').keypress(function(event) {\n        if( event.keyCode == 13 )\n            sendChat();\n    });\n\n    username = prompt('User name:');\n    var password = prompt('Password (make up one if you are logging ' + \n                          'in for the first time):');\n    chat.login(username, password, receiveChat, function(err) {\n        if( err )\n            alert('Invalid username or password. Please refresh the ' + \n                  'page to try againlogin again.');\n        else\n            $('h1').text('Nox Chat - Logged in as ' + username);\n    });\n});\n```\n\n## API Reference\n\n### Prerequisites\n\nNox has been developed to work together with Express and Socket.IO. Alternative HTTP / websocket libraries could be used with minor modifications to the `get`, `socketAuth` and `socketConn` functions to match those of the alternative platform.\n\n### Creating a Nox application\n\nThe entry point to Nox is `nox()` function exported by requiring `nox`:\n\n`var noxapp = require('nox').nox(requirefun, cookiename, logfun, uglify);`\n\nThe arguments of which are listed below:\n\n| Argument | Description |\n| --- | --- |\n| `requirefun` | a function that returns a required module. This is passed in order to let Nox import modules with desired path. Typically it is passed `function(str) { return require(str); }` |\n| `cookiename` | the sid of the cookie which is used to store HTTP sessions. This should match the sid passed to `express.session()` or similar if using other framework than Express. Optional, defaults to `'nox.sid'` |\n| `logfun` | a function that is called when Nox logs its inner workings; for example, `function(str) { process.stderr.write(str + '\\n'); }`. Optional |\n| `uglify` | if true, runs generated `nox-client.js` through UglifyJS before passing it to the client. Optional |\n\nReturns a Nox application object with the following functions: \n\n| Function | Description |\n| --- | --- |\n| `noxapp.get` | the function that generates `nox-client.js`, should be passed to Express like this: `express.get('/nox-client.js', noxapp.get)` |\n| `noxapp.page` | the function used to add pages to nox, see below |\n| `noxapp.socketAuth` | this function should be called when the websocket `authorization` event arrives, for example: `socketServer.set('authorization', noxapp.socketAuth);` |\n| `noxapp.socketConn` | this function should be called when a websocket connection has been created, for example: `socketServer.on('connection', noxapp.socketConn);` |\n\n### Adding pages to a Nox application\n\nThe most important function which defines how your Nox app behaves is `noxapp.page()`. It defines remote and local modules available to each web page, like this:\n\n`noxapp.page('/example.html', [ 'fs', 'async', './lib.js' ], [ './example.js' ]);`\n\nThe arguments are referenced in more detail below:\n\n| Argument | Description | \n| --- | --- |\n| `url` | The server URL of the page being served. When requesting `nox-client.js`, Nox matches this url to the HTTP Referrer headers to find out which page is being requested. |\n| `server_modules` | An array listing all server-side modules that should be available in the generated `nox-client.js` file for this url. Remote function wrappers are created for all exported functions in these modules. |\n| `client_modules` | An array listing all module file names that are bundled for local execution in the browser. Built-in Node.js modules cannot be included to this array. |\n\nNote: if you want to be able  to `require()` 3rd-party JavaScript code, you can just include the necessary `<script>` tags in the HTML before `/nox-client.js`, and refer to them in the `client_modules` array by name. For example, you could include\n\n`<script src=\"/js/async.js\"></script>` \n\nto your HTML, and add `'async'` to your `client_modules` array; after that you can say `var async = require('async');` in the client code.\n\n### Domains and Sessions\n\nWhen any remote function is being called, the current HTTP session is bound to the active domain before making the call. In fact, the currently active domain has the following additional properties:\n\n`domain.active.socket`\n\nThe actual Socket.IO connected socket. If your app maintains an array of active sessions in order to broadcast callbacks to all of them, for example in a chat application, it is practical to listen for the `disconnect` event in order to drop disconnected clients.\n\n`domain.active.socketSession = {}`\n\nAn initially empty object, you can set values to it which will be stored for the lifetime of the websocket connection.\n\n`domain.active.httpSession`\n\nThe actual HTTP session as fetched from the session store. Please note that this object is just a copy, so if you want to modify the session, you will need to make those changes using the `httpSessionStore`.\n\n`domain.active.httpSessionStore`\n\nThe session store. When the `/nox-client.js` file is requested using `noxapp.get(req, res)`, the session store of the request is stored together with its cookie, and used to set and get the session for websocket callbacks. It has the following methods:\n\n`getCookie()` - returns the cookie associated to this session\n\n`get(function(err, session) {})` - gets the session associated to that cookie\n\n`set(sess, function(err) {})` - stores a modified session to the session store\n\n`modify(function(sess, callback) {}, function(err) {})` - convenience method for modifying the session, internally calling `get`, then the provided function which modifies the session, and then stores it using `set`, and returns to the second callback after the session has been stored.\n\n### Socket connectivity events\n\nIn the client side code, there is a global `nox_rpc` variable that you can use to listen on socket connectivity events, like this:\n\n```javascript\n\nnox_rpc.addListener(function(status) {\n    // status is either 'connect' or 'disconnect'                     \n});\n\n// or you can query the status synchronously\n\nvar connected = nox_rpc.isConnected();\n\n```\n\n## Browser Support\n\nNox should work in all browsers where Socket.IO works (see <a href=\"http://socket.io/#browser-support\">here</a>). However it has not been tested extensively in all browsers yet.\n\n## License\n\n(The MIT License)\n\nCopyright (c) 2013 Antti Saarinen &lt;antti.p.saarinen@gmail.com&gt;\n\nPermission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the 'Software'), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:\n\nThe above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED 'AS IS', WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.",
  "bugs": {
    "url": "https://github.com/asaarinen/nox.js/issues"
  },
  "_id": "nox@0.1.0",
  "dist": {
    "shasum": "6882372506f5d359c17d2088ab8de2987698bc3c",
    "tarball": "http://registry.npmjs.org/nox/-/nox-0.1.0.tgz"
  },
  "_from": "nox@",
  "_npmVersion": "1.3.2",
  "_npmUser": {
    "name": "asaarinen",
    "email": "antti.p.saarinen@gmail.com"
  },
  "maintainers": [
    {
      "name": "asaarinen",
      "email": "antti.p.saarinen@gmail.com"
    }
  ],
  "directories": {},
  "_shasum": "6882372506f5d359c17d2088ab8de2987698bc3c",
  "_resolved": "https://registry.npmjs.org/nox/-/nox-0.1.0.tgz"
}
